from scrapy.spider import BaseSpider
from scrapy.selector import HtmlXPathSelector
from scrapy.http import Request

from product.items import Product

def complete_url(string):
    """Return complete url"""
    return "http://www.futureshop.ca/" + string
    
def get_until_para(title):
    new_title = ''
    desc = ''
    
    splitted_text = title.split('(')
    new_title = splitted_text[0]
    desc = splitted_text[1]
    new_desc = desc.replace(')', "")
    
    return (new_title, new_desc)
        
    

class FutureShop(BaseSpider):
    name = "futureshop"
    allowed_domains = ["futureshop.ca"]
    start_urls = [
        "http://www.futureshop.ca/en-CA/category/laptops/33620.aspx?type=product&page=%d" % i for i in range(1,5)
    ]
        
    start_urls = [
        "http://www.futureshop.ca/en-CA/category/ultrabooks/30214.aspx?path=46d1fb9c21d1fb29c0cc77e21ace8368en01"
    ]
    
    def parse(self, response):
        hxs = HtmlXPathSelector(response)
        sites = hxs.select('//div[@id="ctl00_CC_ctl00_ctl00_ListingContainer"]')
        
        urls = []

        for site in sites:
            urls = site.select("//div[contains(@class,'prod-image')]/*[1]/@href").extract()
            
        for url in urls:
            yield Request(complete_url(url), callback=self.parse_detail_page)
           
            
    def parse_detail_page(self, response):
        hxs = HtmlXPathSelector(response)
        sites = hxs.select('//div[@id="fs-content"]')
        items = []
        
        for site in sites:
            item = Product()
            title = site.select('//*[@id="ctl00_CC_ctl00_PD_lblProductTitle"]/text()').extract()
            price = site.select('(//*[@class="dollars"])[1]/text()').extract()
       
               
                 
            item["title"], item["description"] = get_until_para(title[0])
            item["url"] = response.url
            item["price"] = '$' + price[0]

            items.append(item)

            
        return items

            
            
       
